<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%> <%	String path = request.getContextPath();	String basePath = request.getScheme() + "://"			+ request.getServerName() + ":" + request.getServerPort()			+ path + "/"; %><%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%><%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%><!DOCTYPE html><html>  <head>    <c:choose>    	<c:when test="${user.userTypeId==4}">    		<title>${loginBean.eName} - Bills management</title>    	</c:when>    	<c:otherwise><title>${loginBean.cName} - 账单管理</title></c:otherwise>    </c:choose>    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport" />    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />    <base href="<%=basePath%>" />  </head>  <body class="contrast-red">    <%@ include file="/common/res.jsp" %>    <!-- 引入header头部 -->    <%@ include file="/common/header.jsp" %>     <div id="wrapper">      <!-- 引入左侧导航栏 -->      <%@ include file="/common/nav.jsp" %>      <section id="content">        <div class="container-fluid">          <div class="row-fluid" id="content-wrapper">            <div class="span12">              <div class="page-header">                <h1 class="pull-left">                  <i class="icon-money"></i>                   <c:choose>				    	<c:when test="${user.userTypeId==3 or user.userTypeId==4}">				    		<span>Bills management</span>				    	</c:when>				    	<c:otherwise><span>账单管理</span></c:otherwise>				    </c:choose>                </h1>              </div>                             <c:if test="${user.userTypeId ==1 or user.userTypeId==2}">              <div class="row-fluid" id="" style="">                <div class="span12 box">                  <div class="box-header purple-background">                    <div class="title">                      <div class="icon-pencil"></div>                      <b>                      <c:choose>                       <c:when test="${user.userTypeId==4}">Select the query criteria</c:when>                       <c:otherwise>选择查询条件</c:otherwise>                      </c:choose>                      </b>&nbsp;<span style="color:red;"">${error_msg}</span>                    </div>                    <div class="actions">                      <a href="#" class="btn box-collapse btn-mini btn-link"><i></i></a>                    </div>                  </div>                  <div class="box-content">                    <form id="" accept-charset="UTF-8" action="${pageContext.request.contextPath}/bills.html" class="form form-horizontal" method="post" style="margin-bottom: 0;" />                    <div style="margin:0;padding:0;display:inline">                    <input name="type" type="hidden" value="search" />                    <input name="page" type="hidden" value="0" />                    </div>                                         <div class="control-group">                        <label class="control-label" for="inputSelect">选择学院</label>                        <div class="controls">                          <select id="" name="academyId" class='select2 input-block-level' style="width: 216px;">                          <option value=""></option>                            <c:forEach items="${academyMap}" var="academy">                              <option value="${academy.key}">${academy.value.cName}</option>                            </c:forEach>                          </select>                        </div>                      </div>                      <div class="control-group">                        <label class="control-label" for="inputSelect">选择专业</label>                        <div class="controls">                          <select id="" name="majorId" class='select2 input-block-level' style="width: 216px;">                          <option value=""></option>                            <c:forEach items="${majorMap}" var="major">                              <option value="${major.key}">${major.value.majorChineseName}</option>                            </c:forEach>                            </option>                          </select>                        </div>                      </div>                      <div class="control-group">                        <label class="control-label" for="inputSelect">选择班级</label>                        <div class="controls">                          <select id="" name="cclassId" class='select2 input-block-level' style="width: 216px;">                          <option value=""></option>                            <c:forEach items="${classMap}" var="amc">                             <option value="${amc.value.cclass.classId}">${amc.value.cclass.cName}</option>                            </c:forEach>                          </select>                        </div>                      </div>					                                            <hr class='hr-normal' />                      <div class="control-group">                        <div class="controls">                          <button class="btnNisal" style="margin: 0px;" type="submit" id="">                          <c:choose>                        		<c:when test="${user.userTypeId==4}">Search</c:when>                        		<c:otherwise> 查询</c:otherwise>                        	</c:choose>                          </button>                        </div>                      </div>                    </form>                  </div>                </div>                <hr class='hr-double' />              </div>              </c:if>                                                        <div class="row-fluid">                <div class="span12 box bordered-box orange-border" style="margin-bottom:0;">                  <div class="box-header purple-background">                    <div class="title">                    <c:choose>				    	<c:when test="${user.userTypeId==3 or user.userTypeId==4}">				    		<b>Bills Informations</b>				    	</c:when>				    	<c:otherwise><b>账单信息</b></c:otherwise>				    </c:choose>                                        </div>                    <div class="actions">                      <a href="#" class="btn box-collapse btn-mini btn-link"><i></i></a>                    </div>                  </div>                  <div class="box-content box-no-padding">                    <div class="responsive-table">                      <div class="scrollable-area">                        <table class="table table-bordered table-striped" style="margin-bottom:0;">                          <thead>                          <c:choose>                            <c:when test="${user.userTypeId==1 or user.userTypeId==2}">                             <tr>                              <th>缴费人</th>                              <th>联系方式</th>                              <th>时间</th>                              <th>应缴金额</th>                              <th>实缴金额</th>                              <c:if test="${user.userTypeId==1}"><th>继续缴费</th>                              <th>查看详情</th>                              </c:if>                            </tr>                            </c:when>                            <c:otherwise>                              <tr>                              <th>Payer</th>                              <th>Phone</th>                              <th>Recent Pay</th>                              <th>Needs to pay</th>                              <th>Paid</th>                              <c:if test="${user.userTypeId==1}">                              <th>continue to pay</th>                              <th>check detail</th>                              </c:if>                               <c:if test="${user.userTypeId==4}">                               <th>Payment Type</th>                              </c:if>                            </tr>                            </c:otherwise>                          </c:choose>                                                      </thead>                          <tbody>                          <c:forEach items="${payments}" var="payment">                           <tr>                              <td><a href="${pageContext.request.contextPath}/studentInfo.html?type=init&id=${payment.user.userId}" target="_blank">${payment.user.fullName}</a></td>                              <td class="phoner">${payment.user.phone}</td>                              <c:choose>                              	<c:when test="${user.userTypeId==1 or user.userTypeId==2}">                              	 <td class="assessment getSemester">[${payment.validTime}] - [${payment.invalidTime}]</td>                              	</c:when>                              	<c:otherwise>                              	<td class="">${payment.payDate}</td>                              	</c:otherwise>                              </c:choose>                                                            <td class="totalmoney">${payment.totalMoney}</td>                              <td class="money">${payment.money}</td>                              <c:choose>                              	<c:when test="${user.userTypeId==1 or user.userTypeId==2}">                              	 <c:if test="${user.userTypeId==1}">                              	 <td class="updateBill">继续缴费<input type="hidden" name="id" value="${payment.user.userId}"></td>                              	 </c:if>                              	 <td class="billInfo">详情<input type="hidden" name="id" value="${payment.user.userId}"></td>                              	                              	</c:when>                              	<c:otherwise>                              	</c:otherwise>                              </c:choose>                               <c:if test="${user.userTypeId==4}">                               <td class="">${payment.paymentType.eName}</td>                              </c:if>                            </tr>                          </c:forEach>                          </tbody>                        </table>                      </div>                    </div>                  </div>                  <div class="paging">                    <c:choose>                      <c:when test="${user.userTypeId==1 or user.userTypeId==2}">                                            <a class="prev" href="${pageContext.request.contextPath}/bills.html?type=search&limit=10&academyId=${searchForm.academyId}&majorId=${searchForm.majorId}&cclassId=${searchForm.cclassId}&page=${searchForm.page}">上一页</a>                      <a class="next" href="${pageContext.request.contextPath}/bills.html?type=search&limit=10&academyId=${searchForm.academyId}&majorId=${searchForm.majorId}&cclassId=${searchForm.cclassId}&page=${searchForm.page}">下一页</a>                      <input onkeydown="onlyNum();" type="text" name="page" value="" placeholder="page">                      <span class="nowPage">${searchForm.page}</span>/<span class="maxPage">${searchForm.pages}</span>                      <a class="trun" href="">跳转</a>                      </c:when>                      <c:otherwise>                      <%--                      <a class="prev" href="${pageContext.request.contextPath}/bills.html?type=search&limit=10&academyId=${searchForm.academyId}&majorId=${searchForm.majorId}&cclassId=${searchForm.cclassId}&page=${searchForm.page}">PREV</a>                      <a class="next" href="${pageContext.request.contextPath}/bills.html?type=search&limit=10&academyId=${searchForm.academyId}&majorId=${searchForm.majorId}&cclassId=${searchForm.cclassId}&page=${searchForm.page}">NEXT</a>                       --%>                      </c:otherwise>                    </c:choose>                    <%--                    <c:choose>                      <c:when test="${user.userTypeId==1 or user.userTypeId==2}"><a class="trun" href="">跳转</a></c:when>                      <c:otherwise><a class="trun" href="">TURN</a></c:otherwise>                    </c:choose>                     --%>                                      </div>                </div>              </div>                            <hr class="hr-double">                            <c:if test="${user.userTypeId==1 or user.userTypeId==2 or user.userTypeId==4}">              <div class="row-fluid" style="display: none;" id="stuBillInfo">                <div class="span12 box bordered-box orange-border" style="margin-bottom:0;">                  <div class="box-header purple-background">                    <div class="title"><b>个人账单详情</b></div>                    <div class="actions">                      <a href="#" class="btn box-collapse btn-mini btn-link"><i></i></a>                    </div>                  </div>                  <div class="box-content box-no-padding">                    <div class="responsive-table">                      <div class="scrollable-area">                        <table class="table table-bordered table-striped" style="margin-bottom:0;">                          <thead>                            <tr>                              <td>缴费人</td>                              <td>缴费项目</td>                              <td>应缴金额</td>                              <td>已缴金额</td>                              <td>操作人</td>                              <td>最近一次缴费日期</td>                              <td>最近一次缴费说明</td>                            </tr>                          </thead>                          <tbody id="billInfoer">                          </tbody>                        </table>                      </div>                    </div>                  </div>                </div>              </div>              </c:if>            </div>          </div>        </div>      </section>    </div>            <!-- 添加个人账单 -->    <div style="display: none;" class="" id="updateBill">      <form accept-charset="UTF-8" action="${pageContext.request.contextPath}/bills.html" class="form form-horizontal" method="post" style="margin-bottom: 0;" />      <div style="margin:0;padding:0;display:inline">      <input name="type" type="hidden" value="add" />	  <input name="op" type="hidden" value="bills" />      </div>        <input type="hidden" id="updateBillPerId" name="" value="">        <div class="control-group" style="margin-top: 20px;">          <label class="control-label" for="">缴费人手机号或邮箱</label>          <div class="controls">            <input name="condition" id="conditioner" readonly="readonly" placeholder="缴费人手机号或邮箱" type="text" value=""/>          </div>        </div>                <div class="control-group">          <label class="control-label" for="">缴费项目</label>          <div class="controls">            <select name="paymentTypeId" id="updatePaymentType" class='select2 input-block-level' style="width: 216px;" id="">                          </select>          </div>        </div>                <div class="control-group" style="">          <!-- <label class="control-label" for="">应缴金额</label> -->          <div class="controls">            <!-- <input id="updateTotalNeeds" name="totalNeeds" id="" placeholder="应缴金额" type="text" /> -->            <span>应缴金额:<span id="updateTotalMoney"></span></span>&emsp;&emsp;<span>已缴金额:<span id="updateAlready"></span></span>          </div>        </div>        <div class="control-group" style="">          <label class="control-label" for="">本次金额</label>          <div class="controls">            <input id="updateMondy" name="money" id="" placeholder="本次金额" type="text" />          </div>        </div>                <div class="control-group" style="">          <label class="control-label" for="">描述</label>          <div class="controls">            <input id="updateDescribe" name="describe" id="" placeholder="描述" type="text" value=""/>          </div>        </div>        <hr class='hr-normal' />        <div class="control-group">          <div class="controls">            <button class="btnNisal" id="continueAddPayment" style="margin: 0px;" type="button">添加</button>          </div>        </div>      </form>    </div>   <script>      	  $(document).ready(function(){   		  var sem = $('.getSemester')[0].innerHTML.slice(-3, -2); 		  $('.selTerm').removeAttr('checked'); 		  if(sem === '1') $('#seleSemester').attr('checked', 'checked'); 		  if(sem === '2') $('#t2').attr('checked', 'checked');   	  });         function onlyNum() {        if(!(event.keyCode==46)&&!(event.keyCode==8)&&!(event.keyCode==37)&&!(event.keyCode==39))        if(!((event.keyCode>=48&&event.keyCode<=57)||(event.keyCode>=96&&event.keyCode<=105)))        event.returnValue=false;      }      $(document).ready(function(){    	  $('.selTerm').click(function(){    		  $('.selTerm').each(function(){    			  $(this).removeAttr("checked");    		  });    	  	  $(this).attr("checked", "checked");    	  });          var nowPage = parseInt($(".nowPage").html());          $(".prev").click(function(){            if(nowPage <= 1){              layer.msg("已经是第一页了");              return false;            }             window.location.href = window.location.href.replace(/\d{1,}$/g, nowPage - 1);          });          $(".next").click(function(){            if(nowPage >= parseInt($(".maxPage").html())){              layer.msg("已经是最后一页了");              return false;            }             window.location.href = window.location.href.replace(/\d{1,}$/g, nowPage + 1);          });                  var paymentObj = {};        $(".updateBill").click(function(){		    var id = $(this).find('input').val();		    $('#updateTotalMoney').html($(this).parent().find('.totalmoney').html());        	$('#updateAlready').html($(this).parent().find('.money').html());        	$.ajax({                type: "POST",                url: "./bills.html",                data: {                  type: 'initAdd',                  id : id                },                dataType: "json",                success: function(data){                	paymentObj = data;                	$('#updatePaymentType').empty();                	for(var i = 0; i < data.length; i ++){                		var opt = $('<option></option>');                		opt.val(data[i].paymentType.paymentTypeId);                		opt.text(data[i].paymentType.cName);                		$('#updatePaymentType').append(opt);                	}                	$('#updatePaymentType').val(data[0].paymentType.paymentTypeId);                	$('#updatePaymentType').parent().find('span').html(data[0].paymentType.cName);                	$('#updateTotalMoney').html(data[0].totalMoney);                	$('#updateAlready').html(data[0].money);                },                error: function(jqXHR){                   layer.msg("发生错误：" + jqXHR.status);                },              });          $("#conditioner").val($(this).parent().find('.phoner').html());          $('#updateBillPerId').val(id);          var index = layer.open({            type: 1,            anim: 0,            zIndex: 100,            title: "添加账单",            resize: false,            shade: 0.3,            area: ["80%", "auto"],            content: $("#updateBill"),          });        });        $('#updatePaymentType').click(function(){        	var val = $(this).val();        	var itemList = [];        	for(var i = 0; i < paymentObj.length; i ++){       			itemList.push(paymentObj[i].paymentType.paymentTypeId);        	}			var flag = 0;        	for(var j = 0; j < itemList.length; j ++){        		if(val == itemList[j]){        			flag = 1;        			break;        		}        	}        	if(flag === 0){        		$('#updateTotalMoney').html('该项目没有缴费记录');            	$('#updateAlready').html('该项目没有缴费记录');        	}else{        		for(var k = 0; k < paymentObj.length; k ++){        			if(paymentObj[k].paymentType.paymentTypeId == val){        				$('#updateTotalMoney').html(paymentObj[k].totalMoney);                    	$('#updateAlready').html(paymentObj[k].money);                    	break;        			}        		}        	}        });                $(".paging .trun").click(function(){            var page = $(".paging input").val();            if(page === ""){              layer.msg("请填入页码");              return false;            }            var link = window.location.href;            var src  = link.replace(/\d{1,}$/g, page);            window.location.href = src;            return false;          });        $(".billInfo").click(function(){          var id = $(this).find("input").val();          //var schoolYear = $('#seleYear option:selected').val();          //var check = document.getElementById("seleSemester").checked;          //var semester=2;          //if(check){        //	  semester=1;          //}                    	var objer = {};	      	objer.id = id;	      	//objer.schoolYear = schoolYear;	      	//objer.semester = semester;      		      	//var str = JSON.stringify(paymentObj);	      	var str = JSON.stringify(objer);	      	//alert(str);      	          $.ajax({            type: "POST",            url: "./bills.html",            data: {              "type":"detail",              "id" : id,              //"schoolYear":schoolYear,              //"semester":semester            },            dataType: "json",            success: function(data){              $("#stuBillInfo").slideDown();              layer.msg("读取成功");              var billInfo = "";              $("#billInfoer").empty();              for(i in data){                var isEnough = parseInt(data[i].money) < parseInt(data[i].totalMoney) ? "<td style='color: #ff0000;'>" + data[i].money + "</td>" : "<td>" + data[i].money + "</td>";                billInfo += "<tr><td>" + data[i].user.fullName + "</td><td>" + data[i].paymentType.cName + "</td><td>" + data[i].totalMoney + "</td>" + isEnough + "</td>" + "<td>" + data[i].oprUser.fullName + "</td><td>" + data[i].payDate + "</td><td>"+data[i].describle+"</td></tr>";              }              $("#billInfoer").append(billInfo);            },            error: function(jqXHR){               layer.msg("发生错误：" + jqXHR.status);            },          });        });                $('#continueAddPayment').click(function(){        	var phone      = $('#conditioner').val();        	var type       = $('#updatePaymentType').val();        	var totalMoney = parseInt($('#updateTotalMoney').html());        	var already    = parseInt($('#updateAlready').html());        	var money      = parseInt($('#updateMondy').val());        	//var schoolYear = $('#updateSchoolYear').val();        	//var team       = $('.updateTheSemester').val() === '1' ? '1' : '2';        	var describe   = $('#updateDescribe').val();        	var id 		   = $('#updateBillPerId').val();        	        	if(money > (totalMoney - already)){        		layer.msg('本次缴费金额大于剩余需要缴费金额');        		return;        	}        	        	//$('#updatePaymentType')        	        	var objer = {};        	objer.describle = describe;        	objer.money = money;        	objer.totalMoney = totalMoney.toString();        	//objer.theSemester = team;        	//objer.schoolYear = schoolYear;        	objer.paymentTypeId = type;        	objer.userId = id;        	objer.id = 0;        	objer.paymentOprUser = 0;        	objer.payDate = null;        	objer.status = 0;        	objer.user = null;        	objer.oprUser = null;        	objer.paymentType = null;        	objer.paymentTypes = null;        	        	//var str = JSON.stringify(paymentObj);        	var str = JSON.stringify(objer);        	//alert(str);        	$.ajax({                type: "POST",                url: './bills.html',                data: {                  type: 'add',                  op: 'bills',                  payment: str                },                dataType: "json",                success: function(data){                  if(data.success){                	  window.location.reload();                	  return;                  }                  layer.msg('失败');                },                error: function(jqXHR){                   layer.msg("发生错误：" + jqXHR.status);                },              });        	        });      });    </script>
  </body></html>